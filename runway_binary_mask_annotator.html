<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runway Binary Mask Annotator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .file-input {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        .image-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .image-panel {
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
        }
        .image-panel h3 {
            margin: 0 0 10px 0;
            color: #555;
        }
        canvas {
            border: 1px solid #333;
            cursor: crosshair;
            max-width: 100%;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .current-image {
            text-align: center;
            margin: 10px 0;
            font-size: 18px;
            color: #333;
        }
        .navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        .runway-width {
            margin: 10px;
        }
        .runway-width input {
            width: 60px;
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Runway Binary Mask Annotator</h1>
        
        <div class="controls">
            <input type="file" id="imageInput" accept=".png,.jpg,.jpeg" multiple class="file-input">
            <div class="runway-width">
                <label for="runwayWidth">Runway Width (pixels): </label>
                <input type="number" id="runwayWidth" value="10" min="1" max="50">
            </div>
        </div>

        <div class="current-image" id="currentImage"></div>

        <div class="status" id="status">Load images to start annotation</div>

        <div class="info">
            <strong>Instructions:</strong>
            <ul>
                <li>Load your PNG images using the file input</li>
                <li>Click on the <strong>start point</strong> of the runway</li>
                <li>Click on the <strong>end point</strong> of the runway</li>
                <li>A red line will connect the two points</li>
                <li>The binary mask will show the runway as white line on black background</li>
                <li>Use navigation buttons to process multiple images</li>
                <li>Download the mask when satisfied with the annotation</li>
            </ul>
        </div>

        <div class="image-container">
            <div class="image-panel">
                <h3>Original Image</h3>
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="image-panel">
                <h3>Binary Mask</h3>
                <canvas id="maskCanvas"></canvas>
            </div>
        </div>

        <div class="navigation">
            <button class="btn-primary" id="prevBtn" onclick="previousImage()">« Previous</button>
            <span id="imageCounter">0 / 0</span>
            <button class="btn-primary" id="nextBtn" onclick="nextImage()">Next »</button>
        </div>

        <div class="buttons">
            <button class="btn-secondary" id="clearBtn" onclick="clearPoints()">Clear Points</button>
            <button class="btn-success" id="downloadBtn" onclick="downloadMask()">Download Mask</button>
            <button class="btn-warning" id="downloadAllBtn" onclick="downloadAllMasks()">Download All Masks</button>
        </div>
    </div>

    <script>
        let images = [];
        let currentImageIndex = 0;
        let points = [];
        let originalCanvas, maskCanvas, originalCtx, maskCtx;
        let allMasks = {};

        window.onload = function() {
            originalCanvas = document.getElementById('originalCanvas');
            maskCanvas = document.getElementById('maskCanvas');
            originalCtx = originalCanvas.getContext('2d');
            maskCtx = maskCanvas.getContext('2d');

            document.getElementById('imageInput').addEventListener('change', handleFileSelect);
            originalCanvas.addEventListener('click', handleCanvasClick);
            
            updateStatus();
        };

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            images = files.filter(file => file.type.startsWith('image/'));
            currentImageIndex = 0;
            allMasks = {};
            
            if (images.length > 0) {
                loadCurrentImage();
            }
            updateStatus();
        }

        function loadCurrentImage() {
            if (images.length === 0) return;
            
            const file = images[currentImageIndex];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Set canvas size to match image
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    maskCanvas.width = img.width;
                    maskCanvas.height = img.height;
                    
                    // Draw original image
                    originalCtx.drawImage(img, 0, 0);
                    
                    // Clear mask
                    maskCtx.fillStyle = 'black';
                    maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
                    
                    // Reset points
                    points = [];
                    
                    // Load existing annotation if available
                    if (allMasks[file.name]) {
                        points = allMasks[file.name].points;
                        drawRunway();
                    }
                    
                    updateStatus();
                };
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
            document.getElementById('currentImage').textContent = `Image: ${file.name}`;
            document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} / ${images.length}`;
        }

        function handleCanvasClick(event) {
            const rect = originalCanvas.getBoundingClientRect();
            const scaleX = originalCanvas.width / rect.width;
            const scaleY = originalCanvas.height / rect.height;
            
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;
            
            if (points.length < 2) {
                points.push({x: x, y: y});
                drawPoint(x, y);
                
                if (points.length === 2) {
                    drawRunway();
                    saveCurrentAnnotation();
                }
                
                updateStatus();
            }
        }

        function drawPoint(x, y) {
            originalCtx.fillStyle = 'red';
            originalCtx.beginPath();
            originalCtx.arc(x, y, 5, 0, 2 * Math.PI);
            originalCtx.fill();
        }

        function drawRunway() {
            if (points.length !== 2) return;
            
            const runwayWidth = parseInt(document.getElementById('runwayWidth').value);
            
            // Draw line on original image
            originalCtx.strokeStyle = 'red';
            originalCtx.lineWidth = 3;
            originalCtx.beginPath();
            originalCtx.moveTo(points[0].x, points[0].y);
            originalCtx.lineTo(points[1].x, points[1].y);
            originalCtx.stroke();
            
            // Draw both points
            points.forEach(point => drawPoint(point.x, point.y));
            
            // Create binary mask
            maskCtx.fillStyle = 'black';
            maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
            
            // Draw thick white line on mask
            maskCtx.strokeStyle = 'white';
            maskCtx.lineWidth = runwayWidth;
            maskCtx.lineCap = 'round';
            maskCtx.beginPath();
            maskCtx.moveTo(points[0].x, points[0].y);
            maskCtx.lineTo(points[1].x, points[1].y);
            maskCtx.stroke();
        }

        function clearPoints() {
            points = [];
            
            // Remove from saved annotations
            if (images.length > 0) {
                const fileName = images[currentImageIndex].name;
                delete allMasks[fileName];
            }
            
            // Reload and redraw the current image
            loadCurrentImage();
            updateStatus();
        }

        function updateStatus() {
            const status = document.getElementById('status');
            if (images.length === 0) {
                status.textContent = 'Load images to start annotation';
                status.style.color = '#666';
            } else if (points.length === 0) {
                status.textContent = 'Click on runway START point';
                status.style.color = '#007bff';
            } else if (points.length === 1) {
                status.textContent = 'Click on runway END point';
                status.style.color = '#ffc107';
            } else {
                status.textContent = 'Runway annotated! Navigate to next image or download mask';
                status.style.color = '#28a745';
            }
        }

        function previousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                loadCurrentImage();
            }
        }

        function nextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                loadCurrentImage();
            }
        }

        function saveCurrentAnnotation() {
            if (images.length > 0 && points.length === 2) {
                const fileName = images[currentImageIndex].name;
                allMasks[fileName] = {
                    points: [...points],
                    maskData: maskCanvas.toDataURL()
                };
            }
        }

        function downloadMask() {
            if (images.length === 0 || points.length !== 2) {
                alert('Please annotate the runway first');
                return;
            }
            
            const fileName = images[currentImageIndex].name;
            const maskName = fileName.replace(/\.[^/.]+$/, '_mask.png');
            
            const link = document.createElement('a');
            link.download = maskName;
            link.href = maskCanvas.toDataURL();
            link.click();
        }

        function downloadAllMasks() {
            if (Object.keys(allMasks).length === 0) {
                alert('No masks to download. Please annotate some images first.');
                return;
            }
            
            // Create a zip-like solution by downloading each mask
            for (const [fileName, data] of Object.entries(allMasks)) {
                const maskName = fileName.replace(/\.[^/.]+$/, '_mask.png');
                const link = document.createElement('a');
                link.download = maskName;
                link.href = data.maskData;
                link.click();
                
                // Small delay between downloads
                setTimeout(() => {}, 100);
            }
        }
    </script>
</body>
</html>